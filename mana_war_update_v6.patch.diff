--- /mnt/data/index.html	2026-01-16 11:09:54.190829152 +0000
+++ /mnt/data/mana_war_update_v6/index.html	2026-01-16 11:15:21.730287121 +0000
@@ -19,7 +19,7 @@
         <div class="chip">üìõ Î≥¥Ïä§ <b id="bossName">-</b></div>
         <div class="chip">‚ö†Ô∏è ÌòÑÏû¨ Ìå®ÌÑ¥ <b id="patternText">-</b></div>
         <div class="chip">‚è≥ Îã§Ïùå Ìå®ÌÑ¥ <b id="nextPatternText">-</b></div>
-        <div class="chip warn" id="doomChip" style="display:none;">üíÄ Í∞ïÏ†úÏ≤≠ÏÇ∞ÍπåÏßÄ <b id="doomText">-</b>s</div>
+        <div class="chip warn" id="doomChip" style="display:none;">üíÄ <span id="doomLabel">Í∞ïÏ†úÏ≤≠ÏÇ∞ÍπåÏßÄ</span> <b id="doomText">-</b><span id="doomUnit">s</span></div>
       </div>
       <div class="right">
         <div class="chip">üßæ Ï†êÏàò <b id="score">0</b></div>
@@ -81,7 +81,7 @@
   </div>
 
   <!-- How To -->
-  <div class="modalBack" id="howModal" aria-hidden="true">
+  <div class="modalBack" id="howModal" data-pauses="true" aria-hidden="true">
     <div class="modalPanel titlePanel" role="dialog" aria-modal="true">
       <div class="badge">üìñ HOW TO PLAY</div>
       <div class="subTitle" style="text-align:left;max-width:720px;margin:14px auto 0;">
@@ -121,7 +121,7 @@
   </div>
 
   <!-- Stage Select -->
-  <div class="modalBack" id="stageModal" aria-hidden="true">
+  <div class="modalBack" id="stageModal" data-pauses="true" aria-hidden="true">
     <div class="modalPanel" role="dialog" aria-modal="true">
       <div class="stageHeader">
         <div>
@@ -155,7 +155,7 @@
   </div>
 
   <!-- Loadout -->
-  <div class="modalBack" id="loadoutModal" aria-hidden="true">
+  <div class="modalBack" id="loadoutModal" data-pauses="true" aria-hidden="true">
     <div class="modalPanel" role="dialog" aria-modal="true">
       <div class="loadoutTop">
         <div>
@@ -210,7 +210,7 @@
   </div>
 
   <!-- End -->
-  <div class="modalBack" id="endModal" aria-hidden="true">
+  <div class="modalBack" id="endModal" data-pauses="true" aria-hidden="true">
     <div class="modalPanel endPanel" role="dialog" aria-modal="true">
       <div class="endTop">
         <div class="stageBadge2"><div class="code" id="endStage">1-01</div><div class="lv">STAGE</div></div>
--- /mnt/data/style.css	2026-01-16 11:09:43.355308129 +0000
+++ /mnt/data/mana_war_update_v6/style.css	2026-01-16 11:17:50.303286007 +0000
@@ -25,6 +25,8 @@
     .chip{background:#0f1630;border:1px solid #27315d;border-radius:999px;padding:6px 10px;display:flex;gap:8px;align-items:center;font-size:13px}
     .chip b{font-weight:1000}
     .warn{background:rgba(255,71,71,.12);border-color:rgba(255,71,71,.55)}
+    .chip.warn.danger{background:rgba(255,45,45,.18);border-color:rgba(255,45,45,.70);animation:blinkDanger .65s infinite alternate}
+    @keyframes blinkDanger{from{filter:brightness(1)}to{filter:brightness(1.35)}}
 
     .progressWrap{margin-top:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 12px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
     .progressLine{flex:1;min-width:420px;display:flex;gap:10px;align-items:center}
@@ -78,10 +80,12 @@
     .subGrid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:10px}
     .stageBtn{border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);padding:10px 10px;cursor:pointer;text-align:left;display:flex;flex-direction:column;gap:6px;min-height:74px}
     .stageBtn.active{background:rgba(105,210,255,.12);border-color:rgba(105,210,255,.40)}
+    .stageBtn.cleared{background:rgba(105,210,255,.16);border-color:rgba(105,210,255,.62)}
     .stageBtn .t{font-weight:1000;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
     .stageBtn .d{font-size:12px;opacity:.82;line-height:1.35}
     .subBtn{border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);padding:10px 10px;cursor:pointer;text-align:center;display:flex;flex-direction:column;gap:4px;min-height:74px}
     .subBtn.midboss{background:rgba(255,220,110,.10);border-color:rgba(255,220,110,.30)}
+    .subBtn.cleared{background:rgba(105,210,255,.16);border-color:rgba(105,210,255,.62)}
 
     .actions{margin-top:12px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
 
@@ -129,9 +133,9 @@
     @media (max-width:860px){.grid2{grid-template-columns:1fr}}
     /* Ïû•Ï∞© Ïä¨Î°Ø: (ÏöîÍµ¨) ÌÉ≠Îãπ 3Ïä¨Î°ØÏù¥ Ìïú Ï§ÑÏóê Í≥†Ï†ï */
     .slotRow{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
-    @media (max-width:720px){.slotRow{grid-template-columns:1fr}}
-    .slot{min-width:0;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);padding:10px 10px;cursor:pointer;display:flex;align-items:center;gap:10px}
+        .slot{min-width:0;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);padding:10px 10px;cursor:pointer;display:flex;align-items:center;gap:10px}
     .slot b{font-weight:1000}
+    .slot .name{font-weight:1000;white-space:normal;overflow-wrap:anywhere;line-height:1.15}
 
     .invScroll{max-height:320px;overflow-y:auto;overflow-x:hidden;padding-right:6px}
 
--- /mnt/data/app.js	2026-01-16 11:09:43.292299417 +0000
+++ /mnt/data/mana_war_update_v6/app.js	2026-01-16 11:29:28.953480191 +0000
@@ -12,8 +12,28 @@
     .replace(/\"/g,"&quot;")
     .replace(/'/g,"&#039;");
 
-  function showModal(m){ m.classList.add("show"); m.setAttribute("aria-hidden","false"); }
-  function hideModal(m){ m.classList.remove("show"); m.setAttribute("aria-hidden","true"); }
+  // Modal pause (Í≤åÏûÑ ÏßÑÌñâ Ï§ë Ïä§ÌÖåÏù¥ÏßÄ/Ïû•ÎπÑ/How to Ïó¥Î©¥ ÏùºÏãúÏ†ïÏßÄ)
+  let pausedByModal = false;
+  function updateModalPause(){
+    try{
+      pausedByModal = !!document.querySelector('.modalBack.show[data-pauses="true"]');
+    }catch(_e){
+      pausedByModal = false;
+    }
+  }
+
+  function showModal(m){
+    if(!m) return;
+    m.classList.add("show");
+    m.setAttribute("aria-hidden","false");
+    updateModalPause();
+  }
+  function hideModal(m){
+    if(!m) return;
+    m.classList.remove("show");
+    m.setAttribute("aria-hidden","true");
+    updateModalPause();
+  }
 
   // =========================
   // Config
@@ -490,6 +510,8 @@
   const nextPatternTextEl = el("nextPatternText");
   const doomChip = el("doomChip");
   const doomTextEl = el("doomText");
+  const doomLabelEl = el("doomLabel");
+  const doomUnitEl = el("doomUnit");
   const scoreEl = el("score");
   const coinsEl = el("coins");
   const basePEl = el("baseP");
@@ -764,7 +786,8 @@
     for(let m=1;m<=MAIN_STAGE_COUNT;m++){
       const master = masterFor(m);
       const div = document.createElement("div");
-      div.className = "stageBtn" + (m===selectedMain?" active":"");
+      const anyCleared = Array.from({length:SUB_STAGE_COUNT}, (_,i)=> getBestProgress(stageCode(m, i+1)) >= 30).some(Boolean);
+      div.className = "stageBtn" + (m===selectedMain?" active":"") + (anyCleared?" cleared":"");
       div.innerHTML = '<div class="t">STAGE '+m+' <span style="opacity:.75">¬∑</span> <span style="opacity:.9">'+escapeHtml(master.bossName)+'</span></div>'
         + '<div class="d">'+escapeHtml(master.gimmick)+'</div>';
       div.addEventListener("click", ()=>{ selectedMain=m; buildStageUI(); });
@@ -778,7 +801,8 @@
       const code = stageCode(selectedMain, s);
       const btn = document.createElement("button");
       btn.type = "button";
-      btn.className = "subBtn" + (s===MIDBOSS_SUB_INDEX?" midboss":"");
+      const cleared = (getBestProgress(code) >= 30);
+      btn.className = "subBtn" + (s===MIDBOSS_SUB_INDEX?" midboss":"") + (cleared?" cleared":"");
       btn.innerHTML = '<div style="font-weight:1000;font-size:16px;">'+s+'</div>'
         + '<div style="font-size:11px;opacity:.85;">'+(s===MIDBOSS_SUB_INDEX?"B":"")+'</div>';
       btn.addEventListener("click", ()=>{
@@ -1020,6 +1044,9 @@
   }
 
   function updateEntities(dt){
+    const units = state.units;
+    const enemies = state.enemies;
+
     // Ï∂©Îèå/Ï∂îÏõî Î∞©ÏßÄÏö© Í∞ÑÍ≤©
     const BODY_R = 14;
     const BLOCK_DIST = BODY_R * 2 + 2;
@@ -1027,13 +1054,14 @@
     const enemyBaseEdge = state.baseE.x - state.baseE.w/2;
     const playerBaseEdge = state.baseP.x + state.baseP.w/2;
 
-    // Units
+    // --- ÏïÑÍµ∞ ---
     for(const u of units){
-      // nearest enemy in front
+      // ÌÉÄÍ≤ü: Í∞ÄÏû• Í∞ÄÍπåÏö¥ Ï†Å(Í∞ÄÎä•ÌïòÎ©¥ Ï†ÑÎ∞©), ÏóÜÏúºÎ©¥ Í∞ÄÏû• Í∞ÄÍπåÏö¥ Ï†Å(ÌõÑÎ∞© Ìè¨Ìï®)
       let target = null;
       let best = Infinity;
       let signed = 0;
 
+      // 1) Ï†ÑÎ∞© Ïö∞ÏÑ†
       for(const e of enemies){
         const sdx = e.x - u.x;
         if(sdx >= 0 && sdx < best){
@@ -1042,12 +1070,12 @@
           target = e;
         }
       }
-      // overlap rescue (when already crossed due to dt)
+      // 2) ÌõÑÎ∞© Ìè¨Ìï®(Ïù¥ÎØ∏ Ï∂îÏõîÌï¥Î≤ÑÎ¶∞ Í≤ΩÏö∞)
       if(!target){
         for(const e of enemies){
           const sdx = e.x - u.x;
           const dist = Math.abs(sdx);
-          if(dist < BLOCK_DIST && dist < best){
+          if(dist < best){
             best = dist;
             signed = sdx;
             target = e;
@@ -1055,11 +1083,19 @@
         }
       }
 
+      // Í≥µÍ≤© Ïø®Îã§Ïö¥ Ï≤òÎ¶¨
+      u.cd = (typeof u.cd === "number") ? u.cd : 0;
+      u.cd -= dt;
+
       if(!target){
+        // Ï†ÅÏù¥ ÏóÜÏúºÎ©¥ Î≥∏ÏßÑÏúºÎ°ú
         const dxBase = enemyBaseEdge - u.x;
         if(dxBase <= u.range){
-          state.baseE.hp = Math.max(0, state.baseE.hp - u.atk);
-          state.dmgToEnemyBase += u.atk;
+          if(u.cd <= 0){
+            state.baseE.hp = Math.max(0, state.baseE.hp - u.atk);
+            state.dmgToEnemyBase += u.atk;
+            u.cd = 1 / Math.max(0.1, u.rate||1);
+          }
         }else{
           const nextX = u.x + u.speed*dt;
           u.x = Math.min(nextX, enemyBaseEdge - (BODY_R + 2));
@@ -1067,25 +1103,29 @@
       }else{
         const dist = Math.abs(target.x - u.x);
         if(dist <= u.range){
-          target.hp -= u.atk;
+          if(u.cd <= 0){
+            target.hp -= u.atk;
+            u.cd = 1 / Math.max(0.1, u.rate||1);
+          }
         }else{
           const nextX = u.x + u.speed*dt;
-          if(signed >= 0){
-            u.x = Math.min(nextX, target.x - BLOCK_DIST);
-          }else{
-            // should be rare; still move forward
-            u.x = nextX;
-          }
+          // targetÏù¥ Ï†ÑÎ∞©/ÌõÑÎ∞© Ïñ¥ÎîîÎì†, Ìï≠ÏÉÅ stop lineÏùÑ Í∞ïÏ†úÌï¥ Ï∂îÏõîÏùÑ ÏõêÏ≤ú Ï∞®Îã®
+          const stopX = target.x - BLOCK_DIST;
+          u.x = Math.min(nextX, stopX);
         }
       }
+
+      // Î≤†Ïù¥Ïä§ Í≤ΩÍ≥Ñ
+      u.x = clamp(u.x, playerBaseEdge + (BODY_R + 2), enemyBaseEdge - (BODY_R + 2));
     }
 
-    // Enemies
+    // --- Ï†ÅÍµ∞ ---
     for(const e of enemies){
       let target = null;
       let best = Infinity;
       let signed = 0;
 
+      // 1) Ï†ÑÎ∞©(ÏôºÏ™Ω) Ïö∞ÏÑ†: e.x - u.x >= 0
       for(const u of units){
         const sdx = e.x - u.x;
         if(sdx >= 0 && sdx < best){
@@ -1094,12 +1134,12 @@
           target = u;
         }
       }
-      // overlap rescue
+      // 2) ÌõÑÎ∞© Ìè¨Ìï®(Ïù¥ÎØ∏ Ï∂îÏõîÌï¥Î≤ÑÎ¶∞ Í≤ΩÏö∞)
       if(!target){
         for(const u of units){
           const sdx = e.x - u.x;
           const dist = Math.abs(sdx);
-          if(dist < BLOCK_DIST && dist < best){
+          if(dist < best){
             best = dist;
             signed = sdx;
             target = u;
@@ -1107,10 +1147,16 @@
         }
       }
 
+      e.cd = (typeof e.cd === "number") ? e.cd : 0;
+      e.cd -= dt;
+
       if(!target){
         const dxBase = e.x - playerBaseEdge;
         if(dxBase <= e.range + 20){
-          state.baseP.hp = Math.max(0, state.baseP.hp - e.atk);
+          if(e.cd <= 0){
+            state.baseP.hp = Math.max(0, state.baseP.hp - e.atk);
+            e.cd = 1 / Math.max(0.1, e.rate||1);
+          }
         }else{
           const nextX = e.x - e.speed*dt;
           e.x = Math.max(nextX, playerBaseEdge + (BODY_R + 2));
@@ -1118,19 +1164,21 @@
       }else{
         const dist = Math.abs(e.x - target.x);
         if(dist <= e.range){
-          target.hp -= e.atk;
+          if(e.cd <= 0){
+            target.hp -= e.atk;
+            e.cd = 1 / Math.max(0.1, e.rate||1);
+          }
         }else{
           const nextX = e.x - e.speed*dt;
-          if(signed >= 0){
-            e.x = Math.max(nextX, target.x + BLOCK_DIST);
-          }else{
-            e.x = nextX;
-          }
+          const stopX = target.x + BLOCK_DIST;
+          e.x = Math.max(nextX, stopX);
         }
       }
+
+      e.x = clamp(e.x, playerBaseEdge + (BODY_R + 2), enemyBaseEdge - (BODY_R + 2));
     }
 
-    // cleanup
+    // --- cleanup & rewards ---
     for(let i=units.length-1;i>=0;i--){
       if(units[i].hp<=0) units.splice(i,1);
     }
@@ -1139,7 +1187,57 @@
         enemies.splice(i,1);
         state.kills += 1;
         state.score += 120;
-        state.coins += 1;
+        state.coins += 1; // ÌÇ¨ Î≥¥ÏÉÅ
+      }
+    }
+
+    // --- HARD NO-PASS SOLVER ---
+    // (4) ÏïÑÍµ∞Ïù¥ ÍπäÏàôÌûà Îì§Ïñ¥Í∞Ä Ï†ÅÏù¥ Î¨¥ÏãúÌïòÍ≥† ÏßÄÎÇòÍ∞ÄÎäî ÌòÑÏÉÅ ÏôÑÏ†Ñ Ï∞®Îã®
+    if(units.length && enemies.length){
+      // Ï†ïÎ†¨: ÏïÑÍµ∞ÏùÄ Ïò§Î•∏Ï™ΩÏù¥ Ïïû, Ï†ÅÍµ∞ÏùÄ ÏôºÏ™ΩÏù¥ Ïïû
+      units.sort((a,b)=>a.x-b.x);
+      enemies.sort((a,b)=>a.x-b.x);
+
+      // ÌåÄ ÎÇ¥Î∂Ä Í≤πÏπ®(Í∞ÑÍ≤© Ïú†ÏßÄ)
+      for(let i=units.length-2;i>=0;i--){
+        if(units[i].x > units[i+1].x - BLOCK_DIST){
+          units[i].x = units[i+1].x - BLOCK_DIST;
+        }
+      }
+      for(let i=1;i<enemies.length;i++){
+        if(enemies[i].x < enemies[i-1].x + BLOCK_DIST){
+          enemies[i].x = enemies[i-1].x + BLOCK_DIST;
+        }
+      }
+
+      // ÏñëÌåÄ Í≤ΩÍ≥Ñ(Ï†àÎåÄ Ï∂îÏõî Í∏àÏßÄ): ÏïÑÍµ∞ ÏÑ†Îëê <= Ï†ÅÍµ∞ ÏÑ†Îëê - BLOCK_DIST
+      const uFront = units[units.length-1];
+      const eFront = enemies[0];
+      if(uFront.x > eFront.x - BLOCK_DIST){
+        uFront.x = eFront.x - BLOCK_DIST;
+      }
+      if(eFront.x < uFront.x + BLOCK_DIST){
+        eFront.x = uFront.x + BLOCK_DIST;
+      }
+
+      // Í≤ΩÍ≥Ñ ÏàòÏ†ï ÌõÑ Îã§Ïãú ÎÇ¥Î∂Ä Ï†ïÎ¶¨
+      for(let i=units.length-2;i>=0;i--){
+        if(units[i].x > units[i+1].x - BLOCK_DIST){
+          units[i].x = units[i+1].x - BLOCK_DIST;
+        }
+      }
+      for(let i=1;i<enemies.length;i++){
+        if(enemies[i].x < enemies[i-1].x + BLOCK_DIST){
+          enemies[i].x = enemies[i-1].x + BLOCK_DIST;
+        }
+      }
+
+      // Î≤†Ïù¥Ïä§ Í≤ΩÍ≥Ñ Ïû¨ÌÅ¥Îû®ÌîÑ
+      for(const u of units){
+        u.x = clamp(u.x, playerBaseEdge + (BODY_R + 2), enemyBaseEdge - (BODY_R + 2));
+      }
+      for(const e of enemies){
+        e.x = clamp(e.x, playerBaseEdge + (BODY_R + 2), enemyBaseEdge - (BODY_R + 2));
       }
     }
   }
@@ -1165,7 +1263,7 @@
     if(!state.doomActive || state.doomFired) return;
     if(!state.baseE || !(state.baseE.maxHp>0)) return;
     const ratio = state.baseE.hp / state.baseE.maxHp;
-    if(ratio >= 0.10) return;
+    if(ratio > 0.10) return;
 
     const curAt = getNextDoomAt();
     const desiredAt = state.play + 3; // 3Ï¥à ÏòàÍ≥† ÌõÑ Î∞úÎèô
@@ -1185,9 +1283,18 @@
     fxEl.textContent = String(state.fx);
 
     if(state.doomActive){
-      doomTextEl.textContent = fmt1(Math.max(0, getNextDoomAt() - state.play));
+      const remain = Math.max(0, getNextDoomAt() - state.play);
+      doomTextEl.textContent = fmt1(remain);
+
+      // (B) 15% Ïù¥Ìïò: doomChip ÏûêÏ≤¥Î•º "Í∞ïÏ†úÏ≤≠ÏÇ∞ Í≤ΩÍ≥†"Î°ú Î≥ÄÍ≤Ω
+      const ratio = (state.baseE && state.baseE.maxHp>0) ? (state.baseE.hp / state.baseE.maxHp) : 1;
+      const warn = (!state.doomFired) && (ratio <= 0.15);
+      doomLabelEl.textContent = warn ? "Í∞ïÏ†úÏ≤≠ÏÇ∞ Í≤ΩÍ≥†" : "Í∞ïÏ†úÏ≤≠ÏÇ∞ÍπåÏßÄ";
+      doomUnitEl.textContent = "s";
+      doomChip.classList.toggle("danger", warn);
       doomChip.style.display = "flex";
     }else{
+      doomChip.classList.remove("danger");
       doomChip.style.display = "none";
     }
 
@@ -1382,8 +1489,15 @@
   function tick(ts){
     const dt = Math.min(0.05, (ts-lastTs)/1000);
     lastTs = ts;
-
     if(state.running){
+      // modalÏù¥ Ïó¥Î†§ ÏûàÏúºÎ©¥ Í≤åÏûÑÏù¥ ÏôÑÏ†ÑÌûà Î©àÏ∂§(ÏãúÍ∞Ñ/Ìå®ÌÑ¥/Ïä§Ìè∞/Ïù¥Îèô Î™®Îëê Ï†ïÏßÄ)
+      if(pausedByModal){
+        updateHUD();
+        draw();
+        requestAnimationFrame(tick);
+        return;
+      }
+
       state.play += dt;
       state.timeLeft = Math.max(0, CFG.durationSec - state.play);
 
@@ -1464,6 +1578,17 @@
       throw new Error("TOTEM_BY_GRADE.myth must have at least 1 item");
     }
 
+    // NEW: doom schedule inclusive (ratio <= 0.10)
+    state.doomActive = true;
+    state.doomFired = false;
+    state.play = 50;
+    state.baseE.maxHp = 100;
+    state.baseE.hp = 10; // 10% exactly
+    state.patternQueue = [{ at: 105, name: "Í∞ïÏ†úÏ≤≠ÏÇ∞", type:"doom" }];
+    maybeScheduleDoomFromEnemyHp();
+    const da = getNextDoomAt();
+    if(da > 53.001) throw new Error("doom schedule should trigger at <=10% (expected <=53)");
+
     // NEW: pickRandomItem must always return an item even for missing grade
     const p1 = pickRandomItem("totem", "relic");
     if(!p1 || !p1.id) throw new Error("pickRandomItem fallback failed (totem relic)");
